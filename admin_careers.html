<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Careers - GTAC Admin</title>
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="admin_styles.css">
</head>
<body>
  <div class="admin-layout">
    <div class="admin-sidebar">
      <h2>GTAC Admin</h2>
      <ul class="admin-nav">
        <li><a href="admin_dashboard.html">Dashboard</a></li>
        <li><a href="admin_careers.html" class="active">Careers</a></li>
        <li><a href="admin_services.html">Services</a></li>
        <li><a href="admin_courses.html">Courses</a></li>
        <li><a href="admin_success_stories.html">Success Stories</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
      </ul>
    </div>

    <div class="admin-main-content">
      <h1>Career Opportunities Management</h1>

      <div class="form-card">
        <h2>Add New Career</h2>
        <form id="careerForm" onsubmit="return false;">
          <input type="text" id="careerTitle" placeholder="Job Title" required />
          <input type="text" id="careerLocation" placeholder="Location (e.g., Dhaka, Bangladesh)" required />
          <input type="text" id="careerType" placeholder="Job Type (e.g., Full-time, Part-time)" required />
          <textarea id="careerDescription" placeholder="Job Description" rows="5" required></textarea>
          <textarea id="careerResponsibilities" placeholder="Key Responsibilities (one per line)" rows="5"></textarea>
          <textarea id="careerRequirements" placeholder="Requirements (one per line)" rows="5"></textarea>
          <button type="button" id="addCareerBtn">Add Career</button>
        </form>
        <p id="careerMsg" style="min-height: 2rem; margin-top: 1rem;"></p>
      </div>

      <h2 style="margin-top: 2rem;">All Career Posts</h2>
      <div id="careerList" class="list-grid"></div>
    </div>
  </div>

  <!-- Firebase SDK v10.7.1 with ES Modules -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDOz_CM0eYBrMJhZj0qbm-FQ11P5Wgs9mM",
      authDomain: "gtac-a9db5.firebaseapp.com",
      projectId: "gtac-a9db5",
      storageBucket: "gtac-a9db5.firebasestorage.app",
      messagingSenderId: "826319153432",
      appId: "1:826319153432:web:54b8c12c85b9d951fad66d",
      measurementId: "G-QFDYXLCG11"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    console.log('Firebase initialized successfully');

    // Check authentication
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "admin_login.html";
      } else {
        loadCareers();
        setupForm();
      }
    });

    // Setup form submission handler
    function setupForm() {
      console.log('Setting up form...');
      const form = document.getElementById('careerForm');
      if (!form) {
        console.error('Form not found!');
        setTimeout(setupForm, 100); // Retry after 100ms
        return;
      }

      console.log('Form found, attaching event listener');
      
      // Remove any existing listeners
      const newForm = form.cloneNode(true);
      form.parentNode.replaceChild(newForm, form);
      
      const formToUse = document.getElementById('careerForm');
      
      formToUse.addEventListener('submit', async (e) => {
        console.log('Form submitted!');
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const msgEl = document.getElementById('careerMsg');
        if (!msgEl) {
          console.error('Message element not found!');
          alert('Error: Message element not found. Please refresh the page.');
          return;
        }
        
        const submitBtn = document.getElementById('addCareerBtn');
        
        // Clear previous messages
        msgEl.textContent = '';
        msgEl.style.color = '';
        msgEl.style.display = 'block';
        msgEl.style.padding = '0.75rem';
        msgEl.style.borderRadius = '4px';
        
        // Get form values
        const title = document.getElementById('careerTitle').value.trim();
        const location = document.getElementById('careerLocation').value.trim();
        const type = document.getElementById('careerType').value.trim();
        const description = document.getElementById('careerDescription').value.trim();
        const responsibilities = document.getElementById('careerResponsibilities').value.split('\n').filter(r => r.trim());
        const requirements = document.getElementById('careerRequirements').value.split('\n').filter(r => r.trim());

        console.log('Form values:', { title, location, type, description });

        // Validate required fields
        if (!title || !location || !type || !description) {
          msgEl.textContent = 'Please fill in all required fields (Title, Location, Type, Description)';
          msgEl.style.color = '#dc2626';
          msgEl.style.backgroundColor = '#fef2f2';
          console.log('Validation failed');
          return;
        }

        // Show loading state
        const originalBtnText = submitBtn.textContent;
        submitBtn.textContent = 'Adding...';
        submitBtn.disabled = true;
        msgEl.textContent = 'Adding career...';
        msgEl.style.color = '#2563eb';
        msgEl.style.backgroundColor = '#eff6ff';

        try {
          console.log('Adding career to Firestore...');
          console.log('Database object:', db);
          console.log('Collection path: careers');
          
          // Check if db is initialized
          if (!db) {
            throw new Error('Firestore database not initialized');
          }
          
          const careerData = {
            title: title,
            location: location,
            type: type,
            description: description,
            responsibilities: responsibilities,
            requirements: requirements,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };
          
          console.log('Career data to save:', careerData);
          
          // Add timeout to detect if operation hangs
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Operation timed out after 10 seconds. Check Firestore rules and network connection.')), 10000);
          });
          
          const addPromise = addDoc(collection(db, 'careers'), careerData);
          const docRef = await Promise.race([addPromise, timeoutPromise]);

          console.log('Career added successfully with ID:', docRef.id);
          msgEl.textContent = '✓ Career added successfully! Refreshing list...';
          msgEl.style.color = '#16a34a';
          msgEl.style.backgroundColor = '#f0fdf4';
          formToUse.reset();
          
          // Reload careers list
          try {
            await loadCareers();
            console.log('Careers list reloaded');
          } catch (loadError) {
            console.error('Error reloading careers:', loadError);
            msgEl.textContent = '✓ Career added, but error loading list: ' + loadError.message;
          }
          
          // Clear success message after 5 seconds
          setTimeout(() => {
            msgEl.textContent = '';
            msgEl.style.backgroundColor = '';
          }, 5000);
        } catch (error) {
          console.error('Error adding career:', error);
          console.error('Error code:', error.code);
          console.error('Error details:', error);
          
          let errorMessage = 'Error: ';
          if (error.code === 'permission-denied') {
            errorMessage += 'Permission denied. Please check Firestore security rules. They should allow write access.';
          } else if (error.code === 'unavailable') {
            errorMessage += 'Firestore is unavailable. Check your internet connection.';
          } else if (error.message) {
            errorMessage += error.message;
          } else {
            errorMessage += 'Unknown error occurred. Check browser console (F12) for details.';
          }
          
          msgEl.textContent = errorMessage;
          msgEl.style.color = '#dc2626';
          msgEl.style.backgroundColor = '#fef2f2';
          msgEl.style.display = 'block';
          msgEl.style.padding = '0.75rem';
          msgEl.style.borderRadius = '4px';
          
          // Also show alert for critical errors
          if (error.code === 'permission-denied') {
            alert('PERMISSION DENIED ERROR\n\nYour Firestore security rules are blocking write access.\n\nGo to Firebase Console → Firestore → Rules and set:\n\nrules_version = \'2\';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}\n\n(This is for development only!)');
          } else {
            alert('Error adding career:\n\n' + errorMessage + '\n\nCheck browser console (F12) for more details.');
          }
        } finally {
          // Restore button state
          submitBtn.textContent = originalBtnText;
          submitBtn.disabled = false;
          console.log('Form submission completed');
        }
      });
      
      console.log('Form event listener attached successfully');
      
      // Add click handler directly to button (since we changed it to type="button")
      const submitBtn = document.getElementById('addCareerBtn');
      if (submitBtn) {
        submitBtn.addEventListener('click', async function(e) {
          console.log('Add Career button clicked!');
          e.preventDefault();
          e.stopPropagation();
          
          // Trigger form submission manually
          const formEvent = new Event('submit', { bubbles: true, cancelable: true });
          formToUse.dispatchEvent(formEvent);
        });
        console.log('Button click handler attached');
      } else {
        console.error('Submit button not found!');
      }
    }
    
    // Also try to setup form immediately (in case auth is already done)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking if form setup needed');
        setTimeout(setupForm, 500);
      });
    } else {
      console.log('DOM already loaded, setting up form');
      setTimeout(setupForm, 500);
    }

    // Load careers
    async function loadCareers() {
      const listEl = document.getElementById('careerList');
      if (!listEl) {
        console.error('Career list element not found');
        return;
      }
      
      listEl.innerHTML = '<p>Loading...</p>';

      try {
        console.log('Loading careers from Firestore...');
        const q = query(collection(db, 'careers'), orderBy('createdAt', 'desc'));
        const snapshot = await getDocs(q);
        
        console.log('Careers loaded:', snapshot.size);
        
        if (snapshot.empty) {
          listEl.innerHTML = '<p>No career posts found. Add your first career post above.</p>';
          return;
        }

        listEl.innerHTML = '';
        snapshot.forEach((docData) => {
          const data = docData.data();
          const card = document.createElement('div');
          card.className = 'item-box';
          
          const responsibilitiesHtml = data.responsibilities && data.responsibilities.length > 0
            ? '<h4>Key Responsibilities:</h4><ul>' + data.responsibilities.map(r => `<li>${r}</li>`).join('') + '</ul>'
            : '';
          
          const requirementsHtml = data.requirements && data.requirements.length > 0
            ? '<h4>Requirements:</h4><ul>' + data.requirements.map(r => `<li>${r}</li>`).join('') + '</ul>'
            : '';

          card.innerHTML = `
            <div class="item-content">
              <h3>${data.title || 'Untitled'}</h3>
              <p><strong>Location:</strong> ${data.location || 'N/A'}</p>
              <p><strong>Type:</strong> ${data.type || 'N/A'}</p>
              <p>${data.description || ''}</p>
              ${responsibilitiesHtml}
              ${requirementsHtml}
            </div>
            <div class="item-actions">
              <button onclick="deleteCareer('${docData.id}')" class="btn-delete">Delete</button>
            </div>
          `;
          listEl.appendChild(card);
        });
      } catch (error) {
        console.error('Error loading careers:', error);
        listEl.innerHTML = '<p style="color: #dc2626;">Error loading careers: ' + error.message + '</p>';
      }
    }
    
    // Make loadCareers available globally for delete function
    window.loadCareers = loadCareers;

    // Delete career
    window.deleteCareer = async function (id) {
      if (!confirm('Are you sure you want to delete this career post?')) {
        return;
      }

      try {
        console.log('Deleting career:', id);
        await deleteDoc(doc(db, 'careers', id));
        console.log('Career deleted successfully');
        await loadCareers();
      } catch (error) {
        console.error('Error deleting career:', error);
        alert('Error deleting career: ' + error.message);
      }
    }

    // Logout function
    window.logout = function () {
      signOut(auth)
        .then(() => {
          sessionStorage.removeItem('adminUser');
          window.location.href = "admin_login.html";
        })
        .catch((error) => {
          console.error('Logout error:', error);
        });
    }
  </script>
</body>
</html>

